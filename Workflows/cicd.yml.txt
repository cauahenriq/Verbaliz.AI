name: CI/CD - Verbaliz.AI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  validate-json:
    name: Validar Workflows N8N
    runs-on: ubuntu-latest

    steps:
      - name: Baixar repositório
        uses: actions/checkout@v3

      - name: Verificar sintaxe JSON dos workflows
        run: |
          echo "Validando arquivos JSON..."
          find ./workflows -name "*.json" -print -exec jq empty {} \;

  test-build:
    name: Testar Build do Projeto
    runs-on: ubuntu-latest
    needs: validate-json

    steps:
      - name: Baixar repositório
        uses: actions/checkout@v3

      - name: Simular build
        run: |
          echo "Simulação de build (não há app para buildar)"
          echo "Ambiente OK"

  deploy:
    name: Deploy para a VPS
    runs-on: ubuntu-latest
    needs: test-build

    steps:
      - name: Baixar repositório
        uses: actions/checkout@v3

      - name: Enviar arquivos via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "workflows/*"
          target: "/root/verbaliz-ai/workflows-ci"

      - name: Reiniciar serviço do n8n na VPS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "Copiando workflows para o container..."
            docker cp /root/verbaliz-ai/workflows-ci/. n8n:/home/node/.n8n/
            echo "Reiniciando n8n..."
            docker restart n8n
