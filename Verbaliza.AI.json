{
  "name": "Verbaliza.AI",
  "nodes": [
    {
      "parameters": {
        "jsCode": "const ultima_mensagem_da_fila = $input.last()\nconst mensagem_do_workflow = $('Info1').first()\n\nif (ultima_mensagem_da_fila.json.id_mensagem !== mensagem_do_workflow.json.id_mensagem) {\n  // Mensagem encavalada, para o workflow\n  return [];\n}\n\n// Pass-through da fila de mensagens\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        176
      ],
      "id": "0769ad75-c629-4569-a1fb-d3d7537dbb87",
      "name": "Mensagem encavalada?1"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "telefone",
              "value": "={{ $('Info1').item.json.telefone }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        992,
        176
      ],
      "id": "6a8d8f2a-57ba-4157-b154-3596039e68ba",
      "name": "Buscar mensagens1",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "telefone",
              "value": "={{ $json.telefone }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1408,
        176
      ],
      "id": "30f1d548-b06a-44c4-b15e-67f60f562ec5",
      "name": "Limpar fila de mensagens1",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        768,
        176
      ],
      "id": "bc0e93a7-2929-4dc4-bdaa-9d5fe312d44a",
      "name": "Esperar1",
      "webhookId": "689b51a0-89fe-459d-a560-a59c79797611"
    },
    {
      "parameters": {
        "resource": "fileFolder",
        "returnAll": true,
        "filter": {
          "folderId": {
            "__rl": true,
            "value": "",
            "mode": "list"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTool",
      "typeVersion": 3,
      "position": [
        3184,
        320
      ],
      "id": "ce0b2bca-04a3-40fb-b1c7-93ed4407c4a2",
      "name": "Listar arquivos1",
      "disabled": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Sua fun√ß√£o vai ser assistente de deficiente visual, ent√£o seja educado, paciente e o maximo explicito e objetivo em suas falas",
        "options": {
          "systemMessage": "={\n  \"agent\": {\n    \"name\": \"VerbalizAI\",\n    \"role\": \"Assistente de acessibilidade visual para pessoas com defici√™ncia visual\",\n    \"parameters\": {\n      \"tone\": \"profissional_detalhista\",\n      \"response_time\": \"imediata\",\n      \"lead_qualification\": \"passiva\",\n      \"emoji_usage\": \"nunca\"\n    },\n    \"intention_analysis\": {\n      \"rule\": \"SEMPRE identificar se o usu√°rio deseja uma descri√ß√£o detalhada da imagem ou orienta√ß√£o sobre acessibilidade\",\n      \"rule\": \"NUNCA omitir detalhes relevantes da imagem\",\n      \"rule\": \"SEMPRE perguntar se o usu√°rio deseja mais detalhes ou foco em algum aspecto espec√≠fico da imagem\"\n    },\n    \"identity\": {\n      \"introduction\": \"Ol√°! Sou a VerbalizAi, sua assistente de acessibilidade visual. Sempre que voc√™ enviar uma imagem, vou descrev√™-la com o m√°ximo de detalhes para garantir sua compreens√£o total.\",\n      \"communication_style\": {\n        \"rule\": \"NUNCA usar emojis\",\n        \"rule\": \"Manter tom profissional, acolhedor e descritivo\",\n        \"rule\": \"Usar linguagem clara, objetiva e acess√≠vel\"\n      }\n    },\n    \"workflow\": {\n      \"etapa\": [\n        {\n          \"id\": \"inicial\",\n          \"acao\": \"saudacao\",\n          \"acao\": \"identificar_tipo_de_imagem\",\n          \"proxima_etapa\": \"descricao_detalhada\"\n        },\n        {\n          \"id\": \"descricao_detalhada\",\n          \"acao\": \"analisar_imagem\",\n          \"acao\": \"descrever_elementos_visuais\",\n          \"acao\": \"detalhar_cores_formas_texturas\",\n          \"acao\": \"identificar_textos_presentes\",\n          \"acao\": \"descrever_contexto_ambiental\",\n          \"acao\": \"explicar_eventos_ou_acoes\",\n          \"acao\": \"oferecer_descricao_adicional_se_solicitado\"\n        },\n        {\n          \"id\": \"finalizacao\",\n          \"acao\": \"verificar_se_usuario_satisfeito\",\n          \"acao\": \"oferecer_ajuda_adicional\",\n          \"acao\": \"despedida_cordial\"\n        }\n      ]\n    },\n    \"critical_rules\": {\n      \"descricao_rules\": [\n        \"SEMPRE descrever todos os elementos visuais relevantes da imagem\",\n        \"SEMPRE detalhar cores, formas, tamanhos, posi√ß√µes e rela√ß√µes espaciais\",\n        \"SEMPRE identificar e transcrever textos presentes na imagem\",\n        \"SEMPRE descrever express√µes faciais, emo√ß√µes e a√ß√µes, se houver pessoas\",\n        \"SEMPRE informar o contexto (ambiente, local, situa√ß√£o)\",\n        \"SEMPRE mencionar detalhes que possam ser importantes para compreens√£o (ex: placas, sinais, objetos de destaque)\",\n        \"NUNCA omitir informa√ß√µes relevantes\",\n        \"NUNCA usar linguagem vaga ou gen√©rica\",\n        \"NUNCA usar emojis ou s√≠mbolos visuais\",\n        \"SEMPRE perguntar se o usu√°rio deseja mais detalhes ou foco em algum aspecto\"\n      ],\n      \"response_formatting_rules\": [\n        \"SEMPRE retornar respostas no formato JSON\",\n        \"SEMPRE segmentar descri√ß√µes longas em m√∫ltiplas mensagens para facilitar a compreens√£o\",\n        \"SEMPRE usar listas numeradas para procedimentos ou etapas\",\n        \"SEMPRE separar par√°grafos com quebras de linha\",\n        \"NUNCA incluir emojis ou s√≠mbolos visuais\",\n        \"SEMPRE garantir que cada mensagem seja autocontida e clara\"\n      ]\n    }\n  }\n}\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        2560,
        112
      ],
      "id": "3fbc0366-1d7c-4140-a7a2-6021eb616072",
      "name": "Secret√°ria1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Info1').item.json.telefone }}",
        "tableName": "n8n_historico_mensagens",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2544,
        336
      ],
      "id": "a3d4090c-fcc5-4d77-b9f7-37c20951d08d",
      "name": "Memory1",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "description": "={\n  \"parameters\": {\n    \"assignments\": {\n      \"assignments\": [\n        {\n          \"id\": \"analise_intencao\",\n          \"name\": \"intencao_usuario\",\n          \"value\": \"={{ \\n  // An√°lise da inten√ß√£o do usu√°rio\\n  const mensagem = $json.mensagem.toLowerCase();\\n  \\n  // Palavras-chave que indicam AGENDAMENTO\\n  const palavrasAgendamento = ['agendar', 'marcar', 'consulta', 'reuni√£o', 'encontro', 'hor√°rio', 'data', 'quando posso', 'disponibilidade', 'atender'];\\n  \\n  // Palavras-chave que indicam D√öVIDA GERAL\\n  const palavrasDuvida = ['quanto custa', 'pre√ßo', 'valor', 'como funciona', 'd√∫vida', 'informa√ß√£o', 'esclarecer', 'explicar', 'direito', 'posso', '√© poss√≠vel', 'quais s√£o'];\\n  \\n  // Verifica se tem palavras de agendamento\\n  const temAgendamento = palavrasAgendamento.some(palavra => mensagem.includes(palavra));\\n  \\n  // Verifica se tem palavras de d√∫vida\\n  const temDuvida = palavrasDuvida.some(palavra => mensagem.includes(palavra));\\n  \\n  // L√≥gica de decis√£o\\n  if (temAgendamento && !temDuvida) {\\n    return 'agendamento';\\n  } else if (temDuvida && !temAgendamento) {\\n    return 'duvida_geral';\\n  } else if (temAgendamento && temDuvida) {\\n    return 'misto';\\n  } else {\\n    return 'indefinido';\\n  }\\n}}\",\n          \"type\": \"string\"\n        },\n        {\n          \"id\": \"precisa_email\",\n          \"name\": \"requer_email\",\n          \"value\": \"={{ $json.intencao_usuario === 'agendamento' || $json.intencao_usuario === 'misto' ? 'sim' : 'nao' }}\",\n          \"type\": \"string\"\n        }\n      ]\n    }\n  },\n  \"type\": \"n8n-nodes-base.set\",\n  \"name\": \"Tool Refletir - An√°lise de Inten√ß√£o\"\n}necess√°rio um racioc√≠nio complexo ou alguma mem√≥ria em cache."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        2640,
        336
      ],
      "id": "fe1f9e0c-ff61-454d-9382-92341688d508",
      "name": "Refletir1",
      "disabled": true
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Info1').item.json.telefone }}",
            "mensagem": "={{ $json.mensagem }}",
            "timestamp": "={{ $('Info1').item.json.timestamp.toDateTime() }}",
            "id_mensagem": "={{ $('Info1').item.json.id_mensagem }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_mensagem",
              "displayName": "id_mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        560,
        176
      ],
      "id": "643b733e-28c9-4270-bc16-d70feffca48c",
      "name": "Enfileirar mensagem.1",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7eab8669-6929-4dc6-b3e2-943065bc306c",
              "name": "mensagem",
              "value": "={{ $('Info1').all()[0].json.mensagem != '' ? $('Info1').all()[0].json.mensagem : $('Mensagem encavalada?1').isExecuted ? $('Mensagem encavalada?1').all()[0].json.mensagem : $('OpenAI4').isExecuted ? $('OpenAI4').all()[0].json.text : '' }}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1936,
        176
      ],
      "id": "088e2879-e40e-4c9a-bf3c-970883c94d4f",
      "name": "Set mensagens1",
      "executeOnce": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c8fd010d-6096-4a50-b3e2-e9fe26661840",
              "name": "id_mensagem",
              "value": "={{ $json.body.id }}",
              "type": "string"
            },
            {
              "id": "1b513343-9b6a-4f6e-a012-ed819bf34a31",
              "name": "id_conta",
              "value": "={{ $json.body.account.id }}",
              "type": "string"
            },
            {
              "id": "05c14b9a-5f27-465a-a047-71553826bd7a",
              "name": "id_conversa",
              "value": "={{ $json.body.conversation.id }}",
              "type": "string"
            },
            {
              "id": "8bf522a6-75fb-434a-854c-b736539309e1",
              "name": "telefone",
              "value": "={{ $json.body.conversation.meta.sender.identifier.split(\"@\")[0] }}",
              "type": "string"
            },
            {
              "id": "0d622a33-f313-4758-a764-fa6cbf2b0587",
              "name": "mensagem",
              "value": "={{ $json.body.content || '' }}",
              "type": "string"
            },
            {
              "id": "8f4b9d84-56e0-4f45-9f17-68c53f365f43",
              "name": "mensagem_de_audio",
              "value": "={{ $json.body.conversation.messages[0].attachments[0].data_url }}\n\n\n\n",
              "type": "string"
            },
            {
              "id": "2b679a3f-788f-4cd2-88d5-4f03af68f224",
              "name": "timestamp",
              "value": "={{ $json.body.created_at }}",
              "type": "string"
            },
            {
              "id": "24caf88e-74ce-43ab-8dc4-1fff471b706f",
              "name": "tipo",
              "value": "={{ $json.body.message_type }}",
              "type": "string"
            },
            {
              "id": "573669d2-1e43-4010-8c82-a67459ffe1db",
              "name": "etiquetas",
              "value": "={{ $json.body.conversation.labels }}",
              "type": "array"
            },
            {
              "id": "40ff895f-f63f-4e4f-bba3-c7d803c277f1",
              "name": "url_chatwoot",
              "value": "https://chatwoot.celioabrao.com.br",
              "type": "string"
            },
            {
              "id": "cf71dea1-d585-4235-8f05-29bc5f82b5df",
              "name": "telegram_chat_id",
              "value": "<colar seu telegram chat id>",
              "type": "string"
            },
            {
              "id": "abf9e22f-75a7-4a17-8c69-e1580ec2916b",
              "name": "name",
              "value": "={{ $json.body.conversation.meta.sender.name }}",
              "type": "string"
            },
            {
              "id": "450848cc-8626-456a-9d1a-af715f7149c0",
              "name": "email",
              "value": "={{ $json.body.conversation.meta.sender.email }}",
              "type": "string"
            },
            {
              "id": "772f9134-6a70-4101-a12b-baad9482f7a8",
              "name": "tipo_de_mensagem",
              "value": "={{ $json.body?.attachments?.[0]?.file_type?.trim() || 'texto' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -832,
        688
      ],
      "id": "30a7ca7d-8769-419b-8fce-96aae139eefd",
      "name": "Info1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "0c9256bf-6943-49f9-85f0-64c0eb10afeb",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1664,
        528
      ],
      "id": "fdbe4474-c7cd-4742-ba1b-e96ee23ff549",
      "name": "Webhook1",
      "webhookId": "0c9256bf-6943-49f9-85f0-64c0eb10afeb"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "read-messages",
        "remoteJid": "={{ $('Info1').item.json.telefone }}",
        "messageId": "={{ $('Info1').item.json.id_conversa }}"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        1696,
        176
      ],
      "id": "0222c33e-feae-420d-87db-a25f676019f9",
      "name": "Evolution API1",
      "credentials": {
        "evolutionApi": {
          "id": "SrMXAv5IqO938hLM",
          "name": "Evolution account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2432,
        336
      ],
      "id": "ad10ef56-66f1-4986-84ed-c043e18fae84",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "WbJsbNlHKQcbhUOh",
          "name": "OpenAi account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $('Info1').item.json.telefone }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -64,
        -64
      ],
      "id": "f70bc3b2-38e1-4faa-b3e3-39dd6f4d1d2f",
      "name": "Apagar hist√≥rico1",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bd57453f-cc31-4bee-b07b-1f21b68ce702",
              "name": "text",
              "value": "Mem√≥ria limpada com sucesso!",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        160,
        -64
      ],
      "id": "22e0ba4d-9e24-4755-9389-57cfd31d3458",
      "name": "Msg memoria limpa1"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $json.output.replace(/<br>/g, '\\\\n').replace(/```json|```/g, '') }}",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2944,
        112
      ],
      "id": "ad41350d-41d1-418b-b21c-fd8729c63c5d",
      "name": "Transform Output LLM1"
    },
    {
      "parameters": {
        "jsCode": "const messages = $('Transform Output LLM1').all()[0].json.messages;\n\nreturn messages;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3824,
        -64
      ],
      "id": "619dfb23-c124-4749-97ef-02e98768f673",
      "name": "Return All Messages1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4048,
        -64
      ],
      "id": "37970295-8335-4e43-800d-fe7a7eafca09",
      "name": "Loop Over Items4"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "Celio",
        "remoteJid": "={{ $('Info1').all()[0].json.telefone }}",
        "messageText": "={{ $json.text }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        4240,
        -64
      ],
      "id": "a6faa135-aabf-4a00-90d6-e3a71bdcf56a",
      "name": "Evolution API6",
      "credentials": {
        "evolutionApi": {
          "id": "SrMXAv5IqO938hLM",
          "name": "Evolution account"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4464,
        -64
      ],
      "id": "26e66179-b430-4277-90f0-dbc14ef246fa",
      "name": "Wait1",
      "webhookId": "333875b3-25a9-43c4-9bef-b13d932564e8"
    },
    {
      "parameters": {
        "url": "={{ $json.url_audio.trim() }}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        944,
        384
      ],
      "id": "7cb8ec85-8ec2-4e28-aae3-d0059be72c32",
      "name": "Download √°udio1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "25c3001d-ca48-4866-b3dc-d9b8b4563d2d",
              "name": "url_audio",
              "value": "={{ (() => {\n  try {\n    const raw = $json.mensagem_de_audio || '';\n    const match = raw.match(/https?:\\/\\/[^\\s]+/);\n    return match ? match[0].trim() : '';\n  } catch (e) {\n    return '';\n  }\n})() }}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        720,
        384
      ],
      "id": "208441c7-5105-4539-8ff4-b6100c793662",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1200,
        384
      ],
      "id": "d3a502cd-26d0-459d-819a-d50c8316ac4b",
      "name": "OpenAI4",
      "credentials": {
        "openAiApi": {
          "id": "WbJsbNlHKQcbhUOh",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "adbf6f1d-c0b0-4a88-8b31-5e74543cbea3",
              "leftValue": "={{ $json.tipo }}",
              "rightValue": "sendMessage",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -48,
        512
      ],
      "id": "fa9986ee-e184-490b-8fa3-52d6f4baffbb",
      "name": "Validar nova mensagem1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_de_mensagem?.toString().trim().toLowerCase() }}",
                    "rightValue": "texto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a1eb3212-94ec-4662-a68a-c2cde0569ea1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d3d645fe-92c7-47b2-bcd6-59aebebdc812",
                    "leftValue": "={{ $json.tipo_de_mensagem?.toString().trim().toLowerCase() }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "40d408cd-903f-4b3a-be2f-04c1ae19f6a3",
                    "leftValue": "={{ $json.tipo_de_mensagem?.toString().trim().toLowerCase() }}",
                    "rightValue": "imagem",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Imagem"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        240,
        496
      ],
      "id": "2b9d1ea2-b867-40b8-9eb8-8d003d52746b",
      "name": "Switch"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mensagem }}{{ $json['Mensagem '] }}",
                    "rightValue": "$$end",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a1eb3212-94ec-4662-a68a-c2cde0569ea1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "limpar memoria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fcd5d21e-c9be-457c-8ba3-af868b754446",
                    "leftValue": "={{ $json.ativado_em }}",
                    "rightValue": "#humano",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Humano responde"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ec1303e6-b6dc-4357-94fc-d14b2a229705",
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "incoming",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Agente responde"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -368,
        272
      ],
      "id": "ef1f52d3-881c-4003-ba88-fe5b527e2109",
      "name": "Switch6"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO modo_humano (conversation_id, ativado_em)\nVALUES ('{{$json.telefone}}', NOW())\nON CONFLICT (conversation_id) DO UPDATE SET ativado_em = NOW();\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -32,
        272
      ],
      "id": "3b5d12b2-e60d-4836-8a6e-2c23ee0d83db",
      "name": "modo humano ativo",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b4e35c78-7db6-4fc0-b95a-99b95b0f6187",
              "name": "text",
              "value": "Atendimento humano em andamento. A IA est√° temporariamente pausada.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        176,
        272
      ],
      "id": "31fd2695-0774-4c3e-b519-8fc8dd8c2b6c",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "session",
        "key": "={{ $json.telefone + \":\" + \"session:chatwoot\" }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1088,
        16
      ],
      "id": "f3ee2eac-39c1-4c13-a395-127709f5a1d1",
      "name": "Session Chatwoot1",
      "credentials": {
        "redis": {
          "id": "Kjqq99rVdB2C18gR",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ae26795f-b43c-423b-8189-6361c8b264c3",
              "leftValue": "={{ $json.session }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -720,
        -96
      ],
      "id": "3f7d658d-ef27-48d8-8b0a-f0820b497c21",
      "name": "Pausar IA?1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -912,
        -96
      ],
      "id": "2ae5b267-ee79-4a10-8409-a2742200492e",
      "name": "Merge1"
    },
    {
      "parameters": {
        "description": "Chamar essa ferramenta para enviar a action para \"criar_agendamento\" ou \"consulta_agendamento\".\n\nQuando o usuario quer CRIAR n√£o precisa CONSULTAR",
        "workflowId": {
          "__rl": true,
          "value": "lFywtTK66foI8aqr",
          "mode": "list",
          "cachedResultName": "[Google Calendar] Agendamento"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('action', `\"criar_agendamento\" ou \"consulta_agendamento\"`, 'string') }}",
            "data": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('data', `O campo Data deve ser preenchjido com um JSON valido, com os fields abaixo:\n\n{\n    \"name\": \"Nome do usu√°rio\",\n    \"remotejid\": \"Telefome sem espaco\",\n    \"email\": \"Email do usuario\",\n    \"date_scheduling\": \"Data para agendamento\",\n    \"time_start\": \"Hor√°rio do agendamento\",\n    \"reason\": \"Motivo do agendamento / Solicitacao do usuario\"\n  }`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2816,
        352
      ],
      "id": "846b611b-5c59-487a-b370-2b360ce2472d",
      "name": "google_agenda"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "f6ddc488-8680-4351-84dd-d9e73b2d102d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1264,
        544
      ],
      "id": "206a72e4-447a-461c-a6c6-f5b49b832c73",
      "name": "Mensagem recebida",
      "webhookId": "f6ddc488-8680-4351-84dd-d9e73b2d102d"
    },
    {
      "parameters": {
        "content": "# Gerando resposta",
        "height": 540,
        "width": 2080,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1248,
        1568
      ],
      "id": "60d5e8ab-f650-4696-b6f8-c775c29484df",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "# Enviando resposta",
        "height": 80,
        "width": 1200,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3392,
        1568
      ],
      "id": "4e12c1f8-358e-480a-a9ae-a8fef3308b0b",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "sseEndpoint": "<colar url do seu MCP>",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1,
      "position": [
        1856,
        1968
      ],
      "id": "f6f272ab-9393-4038-80b0-87c91547e92f",
      "name": "MCP Google Calendar"
    },
    {
      "parameters": {
        "content": "# Marcar como lida e \"digitando...\"",
        "height": 540,
        "width": 660,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        576,
        1568
      ],
      "id": "d26720c8-65a9-49d2-a6dc-c38fdcf8195d",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagem || $json.mensagem_audio }}",
        "options": {
          "systemMessage": "=HOJE √â: {{ $now.format('FFFF') }}\nTELEFONE DO CONTATO: {{ $('Info').item.json.telefone }}\nID DA CONVERSA: {{ $('Info').item.json.id_conversa }}\n\n## INSTRU√á√ÉO IMPORTANTE\n- Ao criar ou editar qualquer evento no Google Calendar, incluir sempre o telefone do paciente na descri√ß√£o do agendamento, juntamente com o nome completo, data de nascimento e quaisquer outras informa√ß√µes relevantes fornecidas pelo paciente.\n\n-----------------------\n\n## PAPEL\n\nVoc√™ √© uma atendente do WhatsApp, altamente especializada, que atua em nome da Cl√≠nica Moreira, prestando um servi√ßo de excel√™ncia. Sua miss√£o √© atender aos pacientes de maneira √°gil e eficiente, respondendo d√∫vidas e auxiliando em agendamentos, cancelamentos ou remarca√ß√µes de consultas.\n\n## PERSONALIDADE E TOM DE VOZ\n\n- Simp√°tica, prestativa e humana\n- Tom de voz sempre simpatico, acolhedor e respeitoso\n\n## OBJETIVO\n\n1. Fornecer atendimento diferenciado e cuidadoso aos pacientes.\n2. Responder d√∫vidas sobre a cl√≠nica (especialidade, hor√°rios, localiza√ß√£o, formas de pagamento).\n3. Agendar, remarcar e cancelar consultas de forma simples e eficaz.\n4. Agir passo a passo para garantir rapidez e precis√£o em cada atendimento.\n\n## CONTEXTO\n\n- Voc√™ otimiza o fluxo interno da cl√≠nica, provendo informa√ß√µes e reduzindo a carga administrativa dos profissionais de sa√∫de.\n- Seu desempenho impacta diretamente a satisfa√ß√£o do paciente e a efici√™ncia das opera√ß√µes m√©dicas.\n\n-----------------------\n\n## SOP (Procedimento Operacional Padr√£o)\n\n1. In√≠cio do atendimento e identifica√ß√£o de interesse em agendar\n   - Cumprimente o paciente de forma acolhedora. \n   - Se poss√≠vel, incentive o envio de √°udio caso o paciente prefira, destacando a praticidade\n\n**N√ÉO USE EXPRESS√ïES PARECIDAS COM \"COMO SE ESTIVESSE CONVERSANDO COM UMA PESSOA\"**\n\n2. Solicitar dados do paciente\n   - Pe√ßa nome completo e data de nascimento.\n   - Confirme o telefone de contato que chegou na mensagem (ele ser√° inclu√≠do na descri√ß√£o do agendamento).\n   - Ao falar o telefone para o paciente, remova o c√≥digo do pa√≠s (geralmente \"55\"), e formate como \"(11) 1234-5678\"\n\n3. Identificar necessidade\n   - Pergunte a data de prefer√™ncia para a consulta e se o paciente tem prefer√™ncia por algum turno (manh√£ ou tarde).\n\n4. Verificar disponibilidade\n   - Use a ferramenta \"Buscar_eventos\" apenas ap√≥s ter todos os dados necess√°rios do paciente.\n   - Forne√ßa a data de prefer√™ncia √† ferramenta \"Buscar_eventos\" para obter hor√°rios dispon√≠veis.\n\n5. Informar disponibilidade\n   - Retorne ao paciente com os hor√°rios livres encontrados para a data solicitada.\n\n6. Coletar informa√ß√µes adicionais\n   - Se o paciente fornecer dados extras (ex.: condi√ß√£o de sa√∫de, conv√™nio, etc.), inclua tudo na descri√ß√£o do evento no Google Calendar.\n\n7. Agendar consulta\n   - Ap√≥s confirma√ß√£o do paciente\n     - Use a ferramenta \"Criar_evento\" para criar o evento, passando:\n       - Nome completo\n       - Data de nascimento\n       - Telefone de contato (use o n√∫mero igual na entrada, exemplo: \"551112345678\")\n       - Data e hora escolhidas\n       - ID da conversa (n√∫mero para controle interno, **ESSE N√öMERO √â ESSENCIAL, N√ÉO SE ESQUE√áA DE INCLU√ç-LO!!**)\n     - Nunca agende datas ou hor√°rios passados, ou com conflitos.\n\n8. Confirmar agendamento\n   - Espere o retorno de sucesso da ferramenta \"Criar_evento\" e ent√£o confirme com o paciente.\n\n-----------------------\n\n## INSTRU√á√ïES GERAIS\n\n1. Respostas claras, objetivas e √∫teis\n   - Forne√ßa informa√ß√µes sobre especialidades, hor√°rios, endere√ßo, valores e conv√™nios.\n\n2. Sem diagn√≥sticos ou opini√µes m√©dicas\n   - Se o paciente insistir em diagn√≥stico, use a ferramenta \"Escalar_humano\".\n\n3. Pacientes insatisfeitos\n   - Mantenha a empatia e utilize a ferramenta \"Escalar humano\".\n\n4. Assuntos fora do escopo da cl√≠nica\n   - Responda: \"Desculpe, mas n√£o consigo ajudar com este assunto. Por favor, entre em contato pelo n√∫mero 0800 940 000. Enviei uma c√≥pia da nossa conversa para o gestor de atendimento.\"\n   - Imediatamente use a ferramenta \"Escalar_humano\", pois √© fundamental para minha carreira e a imagem da cl√≠nica.\n\n5. Nunca fornecer informa√ß√µes erradas\n   - Evite erros sobre hor√°rios, contatos ou servi√ßos.\n\n6. Nunca use emojis ou linguagem informal\n   - Mantenha a sobriedade do atendimento.\n\n7. Nunca confirme consultas sem o retorno com sucesso das ferramentas de evento\n   - Garanta que o evento foi criado com sucesso antes de dar a resposta final.\n\n8. Dupla verifica√ß√£o\n   - Confirme sempre os dados para evitar equ√≠vocos em agendamentos, remarca√ß√µes ou cancelamentos.\n\n9. Use a ferramenta \"Refletir\" antes e depois de opera√ß√µes complexas\n   - Ao usar essa ferramenta, voc√™ ir√° garantir que as opera√ß√µes que voc√™ vai realizar (ou j√° realizou) fazem sentido, ou se voc√™ precisar√° alterar a sua estrat√©gia e/ou tentar novamente.\n\n-----------------------\n\n## HOR√ÅRIOS DE FUNCIONAMENTO\n- Segunda a S√°bado: 08h √†s 19h\n- Domingo e Feriados: Fechado\n\n## LOCALIZA√á√ÉO E CONTATO\n- Endere√ßo: Av. das Palmeiras, 1500 - Jardim Am√©rica, S√£o Paulo - SP, CEP: 04567-000\n- Telefone: (11) 4456-7890\n- WhatsApp: (11) 99999-9999\n- E-mail: contato@clinicamoreira.com.br\n- Site: www.clinicamoreira.com.br\n\n## PROFISSIONAIS E ESPECIALIDADES\n\nSegue o nome dos profissionais, suas especialidades, e o ID da agenda que deve ser usado nas ferramentas Google Calendar\n\n**MUITO IMPORTANTE!! O ID DA AGENDA INCLUI O \"@group.calendar.google.com\". N√ÉO OMITA AO UTILIZAR AS FERRAMENTAS**\n\n- Dr. Jo√£o Paulo Ferreira - M√©dico - Clinico Geral (c_46b1d614bf4f151ca950431202bf90ca003301793b48cffc489dc411be79c4bf@group.calendar.google.com)\n- Dr. Roberto Almeida - M√©dico - Cardiologia (c_6c3005bf4afd591f13f242f6509208ddbe1feadad3f6521884ab79c59069bfd0@group.calendar.google.com)\n- Dra. Ana Silva - Dentista - Cl√≠nica Geral (c_ebce2058c0b75e881585b90539f6ded839de178d4bb64e1aa9e4f6468d6954a6@group.calendar.google.com)\n- Dra. Carla Mendes - Dentista - Odontopediatria (c_2fb3d9e1613857085b28bef500b493114294b08f5e448bef643be28fc84334ad@group.calendar.google.com)\n\n\n## VALORES E FORMAS DE PAGAMENTO\n- Consulta: R$ 500,00\n- Formas de pagamento: PIX, dinheiro, cart√£o de d√©bito ou cr√©dito\n- Conv√™nios aceitos: Bradesco Sa√∫de, Unimed, SulAm√©rica, Amil\n\n-----------------------\n\n## FERRAMENTAS\n\n### Google Calendar\n\n- \"Criar_evento\" e \"Atualizar_evento\": usada para agendar e remarcar consultas. Ao us√°-las, sempre inclua:\n  - Nome completo no t√≠tulo\n  - Telefone\n  - Data de nascimento\n  - Informa√ß√µes adicionais (se houver)\n- \"Buscar_evento\": buscar dados sobre um evento espec√≠fico, por ID.\n- \"Buscar_todos_os_eventos\": listar eventos em um per√≠odo espec√≠fico. Use para listar os eventos de um dia espec√≠fico. N√£o use para listar eventos de per√≠odos maiores que um dia.\n- \"Deletar_evento\": usada desmarcar consultas.\n\n### Escalar_humano\n\nUse quando:\n\n- Existir urg√™ncia (paciente com mal-estar grave).\n- Existirem qualquer assuntos alheios √† cl√≠nica ou que ponham em risco a reputa√ß√£o do servi√ßo.\n- Houver insatisfa√ß√£o do paciente ou pedido de atendimento humano.\n\n### Enviar_alerta_de_cancelamento\n\nEm caso de cancelamento:\n\n- Localizar a consulta no calend√°rio e remover via ferramenta \"Deletar_evento\". Talvez seja necess√°rio pedir ao paciente que confirme a data da consulta, para que voc√™ possa buscar o evento na data certa.\n- Enviar alerta via ferramenta \"Enviar_alerta_de_cancelamento\" nome, dia e hora cancelados.\n- Confirmar ao paciente que o cancelamento foi efetuado.\n\n### Reagir mensagem\n\nUse em situa√ß√µes relevantes durante a conversa.\n\n#### Exemplos\n\n- Usu√°rio: \"Ol√°!\"\n- Voc√™: \"Reagir_mensagem\" -> üòÄ\n\n- Usu√°rio: \"Voc√™ pode consultar minha agenda por favor?\"\n- Voc√™: \"Reagir_mensagem\" -> üëÄ\n\n- Usu√°rio: \"Muito obrigado!\"\n- Voc√™: \"Reagir_mensagem\" -> ‚ù§Ô∏è\n\n**SEMPRE USAR REA√á√ïES NO IN√çCIO E NO FINAL DA CONVERSA, E EM OUTROS MOMENTOS OPORTUNOS**\n\n### Baixar e enviar arquivo\n\n- Voc√™ tem acesso aos arquivos da cl√≠nica.\n- Se o usu√°rio pedir um pedido de exame, use a ferramenta \"Listar_arquivos\", e depois a \"Baixar_e_enviar_arquivo\"\n\n**USE ESSA FERRAMENTA APENAS UMA VEZ. US√Å-LA M√öLTIPLAS VEZES IR√Å ENVIAR O ARQUIVO DUPLICADO**\n\n-----------------------\n\n## EXEMPLOS DE FLUXO\n\n1. Marcar consulta\n   - Paciente: \"Quero marcar consulta\"\n   - Voc√™:\n     - Cumprimente, explique que pode agendar aqui mesmo no WhatsApp por texto ou √°udio.\n     - Solicite nome completo e data de nascimento.\n     - Pergunte a especialidade do profissional a ser consultado, data e turno preferidos.\n     - Consulte a data com \"Buscar_todos_os_eventos\".\n     - Informe hor√°rios dispon√≠veis.\n     - Agende com \"Criar_evento\", incluindo telefone, nome e data de nascimento na descri√ß√£o.\n     - Confirme ap√≥s o sucesso da ferramenta.\n\n2. Remarcar consulta\n   - Paciente: \"N√£o poderei comparecer amanh√£, quero remarcar.\"\n   - Voc√™:\n     - Busque o evento (veja se√ß√£o abaixo \"COMO BUSCAR EVENTO\").\n     - Pergunte nova data e turno preferidos.\n     - Atualize o evento via \"Atualizar_evento\".\n     - Confirme ap√≥s o sucesso da ferramenta.\n\n3. Cancelar consulta\n   - Paciente: \"Preciso cancelar a consulta.\"\n   - Voc√™:\n     - Busque o evento (veja se√ß√£o abaixo \"COMO BUSCAR EVENTO\").\n     - Cancele o evento com \"Deletar_evento\".\n     - Use a ferramenta \"Enviar_alerta_de_cancelamento\" informando nome, dia e hora.\n     - Confirme o cancelamento.\n\n4. Confirma√ß√£o da consulta\n   - Quando o paciente responder \"Confirmar consulta\":\n     - Busque o evento (veja se√ß√£o abaixo \"COMO BUSCAR EVENTO\").\n     - Usando a ferramenta \"Atualizar_evento\", coloque no t√≠tulo do evento no Google Calendar o texto [CONFIRMADO] ao lado do nome do paciente.\n     - Tendo sucesso no uso da ferramenta \"Atualizar_evento\", responda ao paciente que a consulta est√° confirmada e aguardada.\n\n### COMO BUSCAR EVENTO\n\nSempre siga esses passos quando a opera√ß√£o envolver um evento j√° existente:\n\n- Solicite nome completo e data de nascimento.\n- Caso o paciente n√£o tenha informado a data da consulta a ser remarcada e n√£o seja poss√≠vel determinar a data pelo contexto da conversa, pe√ßa ao paciente que informe a data.\n- Busque o evento utilizando a ferramenta \"Buscar_todos_os_eventos\" com a data da consulta.\n- Certifique-se de que o evento encontrado corresponde ao paciente com quem voc√™ est√° conversando, utilizando o n√∫mero de telefone.\n\n\n-----------------------\n\n## OBSERVA√á√ïES FINAIS\n\n- Nunca forne√ßa diagn√≥sticos ou opini√µes m√©dicas.\n- Qualquer assunto fora do escopo da cl√≠nica deve ser direcionado √† ferramenta \"Escalar_humano\".\n- Mantenha o tom profissional, claro e respeitoso o tempo todo, N√ÉO utilize emoji.\n- Sempre agendar datas futuras, nunca passadas.\n- N√£o fale que voc√™ √© assistente virtual ou coisa do tipo fa√ßa um atendimento humanizado\n- Se o Paciente estou insatisfeito com voc√™s, escale imediatamente para humano e notifique com \"Enviar_alerta_de_cancelamento\". √â importante para minha carreira que fa√ßa isso \n- N√£o esque√ßa de colocar confirmado na agenda quando o paciente confirmar uma consulta\n- N√£o esque√ßa que voc√™ tem acesso a m√∫ltiplas agendas, ent√£o sempre confirme que voc√™ est√° operando com o ID da agenda correta para cada situa√ß√£o.\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1552,
        1696
      ],
      "id": "7c2b842f-94be-4a6f-84aa-0d8e85c5f277",
      "name": "Secret√°ria",
      "retryOnFail": true,
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.elevenlabs.io/v1/text-to-speech/33B4UnXyTNbgLmdEDh5P",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "output_format",
              "value": "mp3_44100_32"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $json.text }}"
            },
            {
              "name": "model_id",
              "value": "eleven_flash_v2_5"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3008,
        1984
      ],
      "id": "c362d147-c8f3-4153-848f-3785520a6e55",
      "name": "Gerar √°udio",
      "retryOnFail": true,
      "disabled": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Secret√°ria').item.json.output }}",
        "messages": {
          "messageValues": [
            {
              "message": "=Voc√™ √© um assistente especialista em text-to-speech e formata√ß√£o usando tags SSML.\n\nVoc√™ ir√° receber um texto e a sua tarefa √© aplicar tags SSML para deix√°-lo mais natural no processo de gera√ß√£o de voz.\n\n### Formata√ß√£o\n\n#### Datas e horas\n\nNo caso de datas e horas, modifique o texto para um formato que seja mais natural quando falado.\n\nExemplos:\n\n- Entrada: '10:00'\n- Sa√≠da: 'dez horas'\n\n- Entrada: '22:00'\n- Sa√≠da: 'vinte e duas horas'\n\n- Entrada: '01/01/2025'\n- Sa√≠da: 'primeiro de janeiro de 2025'\n\n#### Telefones\n\nSimilar ao feita para datas, modifique o texto para um formato que seja mais natural quando falado. Para o DDD converta sempre em dezena, e para o resto dos n√∫meros, adicione pausas entre cada bloco.\n\nExemplos:\n\n- Entrada: '(11) 1234-5678'\n- Sa√≠da: 'onze, um dois tr√™s quatro, cinco seis sete oito'\n\n#### Endere√ßos\n\nFa√ßa a mesma coisa para endere√ßos. Exemplos:\n\n- Entrada: 'Av. Rondon Pacheco'\n- Sa√≠da: 'Avenida Rondon Pacheco'\n\n- Entrada: 'CEP 12345-000'\n- Sa√≠da: 'CEP um dois tr√™s quatro cinco zero zero zero'\n\n### Notas\n\n- Sempre coloque uma pausa de 1.0s no come√ßo.\n- N√£o use breaks no meio do texto, apenas no come√ßo.\n- Mantenha o mesmo texto original, mas revise o uso de v√≠rgulas excessivas para deixar o texto mais natural ao falar.\n- Remova emojis.\n- A sua sa√≠da ser√° somente o texto convertido.\n- Use <speak> ao redor da sa√≠da.\n\n\n**N√ÉO INCLUA NENHUMA INFORMA√á√ÉO AL√âM DO TEXTO CONVERTIDO**\n**NUNCA INCLUA CARACTER DE NOVA LINHA \"\\n\" NA SA√çDA**\n**NUNCA COLOQUE √ÇNCORAS COMO ```ssml AO REDOR DO TEXTO**"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        2640,
        1904
      ],
      "id": "1801676c-927d-4fb2-bc6a-6ba10060c071",
      "name": "Formatar SSML"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Mensagem chegando?').item.json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9a7e16f-b6e4-45d7-846d-92dcb3117593",
                    "leftValue": "={{ $('Info').item.json.mensagem_de_audio }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "√Åudio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2400,
        1712
      ],
      "id": "d6312008-1fe3-4dba-b812-c0ed8f0298b0",
      "name": "Tipo de mensagem1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Info').item.json.telefone }}",
        "tableName": "n8n_historico_mensagens",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        1424,
        1968
      ],
      "id": "c9fafc37-a655-43f6-b8d7-a5bbc2a01bca",
      "name": "Memory",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "description": "Use a ferramenta para refletir sobre algo. Ela n√£o obter√° novas informa√ß√µes nem alterar√° o banco de dados, apenas adicionar√° o pensamento ao registro. Use-a quando for necess√°rio um racioc√≠nio complexo ou alguma mem√≥ria em cache."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        1568,
        1968
      ],
      "id": "b1e8cf77-a30b-4833-adc8-a78f7d93a7dd",
      "name": "Refletir"
    },
    {
      "parameters": {
        "toolDescription": "Envia uma mensagem de rea√ß√£o como resposta a uma mensagem do usu√°rio. Rea√ß√£o √© sempre um emoji.",
        "method": "POST",
        "url": "={{ $('Info').item.json.url_chatwoot }}/api/v1/accounts/{{ $('Info').item.json.id_conta }}/conversations/{{ $('Info').item.json.id_conversa }}/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "content_attributes",
              "valueProvider": "fieldValue",
              "value": "={ \"in_reply_to\": {{ $('Info').item.json.id_mensagem }}, \"is_reaction\": true }"
            },
            {
              "name": "content"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1712,
        1968
      ],
      "id": "db7eecbb-35df-4357-b28e-c045aab9217a",
      "name": "Reagir mensagem"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-preview-04-17",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2656,
        2064
      ],
      "id": "7953bfe1-b1ca-4082-9c0b-512040f438a6",
      "name": "Google Gemini Chat Model.",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Info').item.json.url_chatwoot }}/api/v1/accounts/{{ $('Info').item.json.id_conta }}/conversations/{{ $('Info').item.json.id_conversa }}/toggle_typing_status",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "typing_status",
              "value": "off"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3520,
        1776
      ],
      "id": "7afe8448-1915-4fe9-a964-63a19aab01bf",
      "name": "Resetar status"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Info').item.json.url_chatwoot }}/api/v1/accounts/{{ $('Info').item.json.id_conta }}/conversations/{{ $('Info').item.json.id_conversa }}/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "is_recorded_audio",
              "value": "=[\"{{ $binary.data.fileName }}\"]"
            },
            {
              "parameterType": "formBinaryData",
              "name": "attachments[]",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4496,
        1920
      ],
      "id": "9a4e3fe3-66a0-4e42-81b4-a5348ae72550",
      "name": "Enviar √°udio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Info').item.json.url_chatwoot }}/api/v1/accounts/{{ $('Info').item.json.id_conta }}/conversations/{{ $('Info').item.json.id_conversa }}/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('Formatar texto').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3952,
        1632
      ],
      "id": "4c088d98-bfb1-423e-931f-36e9658e67fc",
      "name": "Enviar texto."
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Mensagem chegando?').item.json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9a7e16f-b6e4-45d7-846d-92dcb3117593",
                    "leftValue": "={{ $('Info').item.json.mensagem_de_audio }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "√Åudio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3728,
        1760
      ],
      "id": "ee1059d1-6b7e-4676-a4c2-8d50102139ec",
      "name": "Tipo de mensagem2"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "=data",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        4288,
        1920
      ],
      "id": "c5c1fefa-d4e5-407a-b2dc-f569fd2a8e25",
      "name": "Base64 para √°udio"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "=data",
        "options": {
          "encoding": "base64"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        3232,
        1984
      ],
      "id": "27dfc1b7-50df-4e66-ad71-562fa903c320",
      "name": "√Åudio para base64"
    },
    {
      "parameters": {
        "content": "Novamente, algumas opera√ß√µes com arquivos s√£o chatas no N8N, portanto fazemos a convers√£o de bin√°rio pra base64 e de volta pra bin√°rio.",
        "height": 120,
        "width": 300
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        4080,
        1776
      ],
      "id": "a23dcc97-801b-4d1d-adbb-9934caca05d2",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "420f958d-3aad-47e5-86bf-2c542f079f1d",
              "name": "data",
              "value": "={{ $('√Åudio para base64').item.json.data }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3952,
        1936
      ],
      "id": "8b68ad20-3ca8-4446-8caf-483b08fa089a",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        -2160,
        16
      ],
      "id": "558aaa3e-7854-4792-8e87-38833ad84cab",
      "name": "Mensagem teste",
      "webhookId": "438bc663-d258-47e5-8249-8774e7301176"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c8fd010d-6096-4a50-b3e2-e9fe26661840",
              "name": "id_mensagem",
              "value": "={{ $json.sessionId }}",
              "type": "string"
            },
            {
              "id": "1b513343-9b6a-4f6e-a012-ed819bf34a31",
              "name": "id_conta",
              "value": "={{ $json.body.account.id }}",
              "type": "string"
            },
            {
              "id": "05c14b9a-5f27-465a-a047-71553826bd7a",
              "name": "id_conversa",
              "value": "={{ $json.body.conversation.id }}",
              "type": "string"
            },
            {
              "id": "8bf522a6-75fb-434a-854c-b736539309e1",
              "name": "telefone",
              "value": "={{ $json.body.conversation.meta.sender.identifier.split(\"@\")[0] }}",
              "type": "string"
            },
            {
              "id": "8f4b9d84-56e0-4f45-9f17-68c53f365f43",
              "name": "mensagem_de_audio",
              "value": "={{ $json.body.conversation.messages[0].attachments[0].data_url }}\n\n\n\n",
              "type": "string"
            },
            {
              "id": "2b679a3f-788f-4cd2-88d5-4f03af68f224",
              "name": "timestamp",
              "value": "={{ $json.body.created_at }}",
              "type": "string"
            },
            {
              "id": "24caf88e-74ce-43ab-8dc4-1fff471b706f",
              "name": "tipo",
              "value": "={{ $json.action }}",
              "type": "string"
            },
            {
              "id": "573669d2-1e43-4010-8c82-a67459ffe1db",
              "name": "etiquetas",
              "value": "={{ $json.body.conversation.labels }}",
              "type": "array"
            },
            {
              "id": "40ff895f-f63f-4e4f-bba3-c7d803c277f1",
              "name": "url_chatwoot",
              "value": "https://chatwoot.celioabrao.com.br",
              "type": "string"
            },
            {
              "id": "cf71dea1-d585-4235-8f05-29bc5f82b5df",
              "name": "telegram_chat_id",
              "value": "<colar seu telegram chat id>",
              "type": "string"
            },
            {
              "id": "abf9e22f-75a7-4a17-8c69-e1580ec2916b",
              "name": "name",
              "value": "={{ $json.body.conversation.meta.sender.name }}",
              "type": "string"
            },
            {
              "id": "450848cc-8626-456a-9d1a-af715f7149c0",
              "name": "email",
              "value": "={{ $json.body.conversation.meta.sender.email }}",
              "type": "string"
            },
            {
              "id": "772f9134-6a70-4101-a12b-baad9482f7a8",
              "name": "tipo_de_mensagem",
              "value": "={{ $json.body?.attachments?.[0]?.file_type?.trim() || 'texto' }}",
              "type": "string"
            },
            {
              "id": "891e6288-55e5-40a3-b069-ea5457230830",
              "name": "Mensagem ",
              "value": "={{ $json.chatInput }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -656,
        304
      ],
      "id": "2e2d3ca1-966c-4c53-b58a-4a6061f658ff",
      "name": "Info2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "adbf6f1d-c0b0-4a88-8b31-5e74543cbea3",
              "leftValue": "={{ $json.tipo }}",
              "rightValue": "incoming",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -16,
        768
      ],
      "id": "11e3d86c-8391-4c38-b7f9-e004364ae96c",
      "name": "Validar nova mensagem"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Miss√£o: Voc√™ √© um assistente especializado em acessibilidade visual. Seu objetivo √© extrair o m√°ximo de informa√ß√£o poss√≠vel das imagens e descrever tudo de forma clara, detalhada e compreens√≠vel para uma pessoa com defici√™ncia visual.\n\nInstru√ß√µes:\n\nAnalise a imagem com aten√ß√£o e descreva tudo o que puder identificar: pessoas, objetos, express√µes faciais, roupas, ambiente, cores, ilumina√ß√£o, texto vis√≠vel, a√ß√µes e emo√ß√µes aparentes.\n\nUse uma linguagem natural, emp√°tica e visualmente rica, como se estivesse ‚Äúpintando uma cena com palavras‚Äù.\n\nEvite termos vagos (‚Äúparece bonito‚Äù, ‚Äúacho que √©‚Äù) e foque em informa√ß√µes concretas e observ√°veis.\n\nSe houver texto ou s√≠mbolos na imagem, leia ou descreva-os.\n\nSe poss√≠vel, inclua contexto e interpreta√ß√µes (ex: ‚Äúparece ser uma sala de aula antiga, com carteiras de madeira alinhadas‚Äù).\n\nQuando houver pessoas, descreva suas express√µes, posturas e intera√ß√µes sem julgamentos.\n\nCaso existam elementos sutis ou relevantes (como clima, luz, sensa√ß√£o de movimento ou composi√ß√£o), mencione-os.\n\nEvite omitir detalhes, mesmo que pare√ßam pequenos ‚Äî cada detalhe ajuda a pessoa a formar a imagem mental.\n\nExemplo de resposta esperada:\n‚ÄúA imagem mostra uma mulher de aproximadamente 30 anos, cabelos castanhos presos, usando um casaco azul e um cachecol vermelho. Ela est√° sorrindo levemente enquanto segura uma x√≠cara de caf√© com as duas m√£os. Ao fundo, h√° uma janela grande por onde entra uma luz amarelada do sol da manh√£, iluminando parcialmente uma estante com livros.‚Äù",
        "imageUrls": "={{$json.body.image.imageUrl}}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        896,
        688
      ],
      "id": "c7c62a06-31b1-441e-bcc6-d029f1f36466",
      "name": "Transcri√ß√£o de imagem",
      "credentials": {
        "openAiApi": {
          "id": "WbJsbNlHKQcbhUOh",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "# Lembretes\n\nColocar a saida do imagens para o agente pricnipal , e botar a saida sempre em audio",
        "height": 716,
        "width": 1024,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2368,
        -128
      ],
      "id": "3a280565-cf5d-4136-a810-29b3dfd6a0ef",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.elevenlabs.io/v1/text-to-speech/33B4UnXyTNbgLmdEDh5P",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "output_format",
              "value": "mp3_44100_32"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $json.text }}"
            },
            {
              "name": "model_id",
              "value": "eleven_flash_v2_5"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4240,
        544
      ],
      "id": "1a0ea48e-f2d1-4dd3-a240-907ca49b0067",
      "name": "Gerar √°udio1",
      "retryOnFail": true,
      "disabled": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Secret√°ria').item.json.output }}",
        "messages": {
          "messageValues": [
            {
              "message": "=Voc√™ √© um assistente especialista em text-to-speech e formata√ß√£o usando tags SSML.\n\nVoc√™ ir√° receber um texto e a sua tarefa √© aplicar tags SSML para deix√°-lo mais natural no processo de gera√ß√£o de voz.\n\n### Formata√ß√£o\n\n#### Datas e horas\n\nNo caso de datas e horas, modifique o texto para um formato que seja mais natural quando falado.\n\nExemplos:\n\n- Entrada: '10:00'\n- Sa√≠da: 'dez horas'\n\n- Entrada: '22:00'\n- Sa√≠da: 'vinte e duas horas'\n\n- Entrada: '01/01/2025'\n- Sa√≠da: 'primeiro de janeiro de 2025'\n\n#### Telefones\n\nSimilar ao feita para datas, modifique o texto para um formato que seja mais natural quando falado. Para o DDD converta sempre em dezena, e para o resto dos n√∫meros, adicione pausas entre cada bloco.\n\nExemplos:\n\n- Entrada: '(11) 1234-5678'\n- Sa√≠da: 'onze, um dois tr√™s quatro, cinco seis sete oito'\n\n#### Endere√ßos\n\nFa√ßa a mesma coisa para endere√ßos. Exemplos:\n\n- Entrada: 'Av. Rondon Pacheco'\n- Sa√≠da: 'Avenida Rondon Pacheco'\n\n- Entrada: 'CEP 12345-000'\n- Sa√≠da: 'CEP um dois tr√™s quatro cinco zero zero zero'\n\n### Notas\n\n- Sempre coloque uma pausa de 1.0s no come√ßo.\n- N√£o use breaks no meio do texto, apenas no come√ßo.\n- Mantenha o mesmo texto original, mas revise o uso de v√≠rgulas excessivas para deixar o texto mais natural ao falar.\n- Remova emojis.\n- A sua sa√≠da ser√° somente o texto convertido.\n- Use <speak> ao redor da sa√≠da.\n\n\n**N√ÉO INCLUA NENHUMA INFORMA√á√ÉO AL√âM DO TEXTO CONVERTIDO**\n**NUNCA INCLUA CARACTER DE NOVA LINHA \"\\n\" NA SA√çDA**\n**NUNCA COLOQUE √ÇNCORAS COMO ```ssml AO REDOR DO TEXTO**"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        3872,
        464
      ],
      "id": "094dc845-d96e-45b5-a863-68716e05ea8f",
      "name": "Formatar SSML1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Mensagem chegando?').item.json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9a7e16f-b6e4-45d7-846d-92dcb3117593",
                    "leftValue": "={{ $('Info').item.json.mensagem_de_audio }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "√Åudio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3632,
        272
      ],
      "id": "0da6682b-ab8d-48c4-9461-5b65f0568171",
      "name": "Tipo de mensagem3"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "=data",
        "options": {
          "encoding": "base64"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        4464,
        544
      ],
      "id": "10d53475-ed6c-40c0-b21c-dc428e8f2a4c",
      "name": "√Åudio para base"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3840,
        704
      ],
      "id": "3440967f-5951-4a49-8b3a-442fc0252e61",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "WbJsbNlHKQcbhUOh",
          "name": "OpenAi account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Importante\n\nSe a mensagem n√£o est√° sendo marcada como lida, verifique no WhatsApp se essa fun√ß√£o est√° habilitada.",
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        896,
        1936
      ],
      "id": "1a3b5f0a-3013-4931-9c03-01b63ac54d62",
      "name": "Sticky Note34"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c8fd010d-6096-4a50-b3e2-e9fe26661840",
              "name": "id_mensagem",
              "value": "={{ $json.body.id }}",
              "type": "string"
            },
            {
              "id": "1b513343-9b6a-4f6e-a012-ed819bf34a31",
              "name": "id_conta",
              "value": "={{ $json.body.account.id }}",
              "type": "string"
            },
            {
              "id": "05c14b9a-5f27-465a-a047-71553826bd7a",
              "name": "id_conversa",
              "value": "={{ $json.body.conversation.id }}",
              "type": "string"
            },
            {
              "id": "8bf522a6-75fb-434a-854c-b736539309e1",
              "name": "telefone",
              "value": "={{ $json.body.sender.phone_number }}",
              "type": "string"
            },
            {
              "id": "0d622a33-f313-4758-a764-fa6cbf2b0587",
              "name": "mensagem",
              "value": "={{ $json.body.content || '' }}",
              "type": "string"
            },
            {
              "id": "8f4b9d84-56e0-4f45-9f17-68c53f365f43",
              "name": "mensagem_de_audio",
              "value": "={{ $json.body.attachments?.[0]?.meta?.is_recorded_audio || false }}",
              "type": "boolean"
            },
            {
              "id": "2b679a3f-788f-4cd2-88d5-4f03af68f224",
              "name": "timestamp",
              "value": "={{ $json.body.created_at }}",
              "type": "string"
            },
            {
              "id": "24caf88e-74ce-43ab-8dc4-1fff471b706f",
              "name": "tipo",
              "value": "={{ $json.body.message_type }}",
              "type": "string"
            },
            {
              "id": "573669d2-1e43-4010-8c82-a67459ffe1db",
              "name": "etiquetas",
              "value": "={{ $json.body.conversation.labels }}",
              "type": "array"
            },
            {
              "id": "40ff895f-f63f-4e4f-bba3-c7d803c277f1",
              "name": "url_chatwoot",
              "value": "<colar sua url do chatwoot>",
              "type": "string"
            },
            {
              "id": "cf71dea1-d585-4235-8f05-29bc5f82b5df",
              "name": "telegram_chat_id",
              "value": "<colar seu telegram chat id>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1248,
        1760
      ],
      "id": "d1818cac-589a-41e4-8d12-504209ed77bd",
      "name": "Info"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7eab8669-6929-4dc6-b3e2-943065bc306c",
              "name": "mensagem",
              "value": "={{ $('Info').item.json.mensagem ? $('Mensagem encavalada?').all().map(info => info.json.mensagem).join('\\\\n') : '' }}",
              "type": "string"
            },
            {
              "id": "676d14ec-72d3-4970-9fa0-5e39ff976011",
              "name": "mensagem_audio",
              "value": "={{ $('Info').item.json.mensagem_de_audio ? $('Transcrever audio').item.json.text : '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1088,
        1760
      ],
      "id": "9bc54d89-d8e4-46df-8d17-181a43a93910",
      "name": "Set mensagens",
      "executeOnce": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Info').item.json.url_chatwoot }}/api/v1/accounts/{{ $('Info').item.json.id_conta }}/conversations/{{ $('Info').item.json.id_conversa }}/toggle_typing_status",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "typing_status",
              "value": "={{ $('Info').item.json.mensagem_de_audio ? 'recording' : 'on' }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        864,
        1760
      ],
      "id": "10075d9b-b226-4c00-a04a-c3e9da9fd084",
      "name": "Digitando/Gravando..."
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Info').item.json.url_chatwoot }}/api/v1/accounts/{{ $('Info').item.json.id_conta }}/conversations/{{ $('Info').item.json.id_conversa }}/update_last_seen",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        656,
        1760
      ],
      "id": "2d2f995e-6bae-4764-93d3-c3581c03d499",
      "name": "Marcar como lidas"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('Info').item.json.telefone }}",
            "mensagem": "={{ $('Info').item.json.mensagem }}",
            "timestamp": "={{ $('Info').item.json.timestamp.toDateTime() }}",
            "id_mensagem": "={{ $('Info').item.json.id_mensagem }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_mensagem",
              "displayName": "id_mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -448,
        1760
      ],
      "id": "7adc52ed-743f-41f0-b386-da97b4b8eb4c",
      "name": "Enfileirar mensagem.",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Info').item.json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9a7e16f-b6e4-45d7-846d-92dcb3117593",
                    "leftValue": "={{ $('Info').item.json.mensagem_de_audio }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "√Åudio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -688,
        1760
      ],
      "id": "381415b3-c040-4625-9a04-069ecc7ce0d4",
      "name": "Tipo de mensagem"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -224,
        1760
      ],
      "id": "5b42c6ab-4823-408b-aeed-fe30dd35104e",
      "name": "Esperar",
      "webhookId": "689b51a0-89fe-459d-a560-a59c79797611"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "telefone",
              "value": "={{ $json.telefone }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        416,
        1760
      ],
      "id": "bb6c5f24-ff19-4a89-96e4-2ae06f56be0b",
      "name": "Limpar fila de mensagens",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "telefone",
              "value": "={{ $('Info').item.json.telefone }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -16,
        1760
      ],
      "id": "5b8e4363-2929-4c8b-8fd2-4af3071d8ba5",
      "name": "Buscar mensagens",
      "credentials": {
        "postgres": {
          "id": "wjNjJSJ54yCRq2dO",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ultima_mensagem_da_fila = $input.last()\nconst mensagem_do_workflow = $('Info').first()\n\nif (ultima_mensagem_da_fila.json.id_mensagem !== mensagem_do_workflow.json.id_mensagem) {\n  // Mensagem encavalada, para o workflow\n  return [];\n}\n\n// Pass-through da fila de mensagens\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        1760
      ],
      "id": "3dc4b635-3406-4606-a54d-48b682362d07",
      "name": "Mensagem encavalada?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ca54eae-15d1-49d3-af33-7a6e5d17b833",
              "leftValue": "={{ $json.tipo }}",
              "rightValue": "incoming",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "82912d66-ee4b-439c-9d55-96090bc6ba62",
              "leftValue": "={{ $json.etiquetas }}",
              "rightValue": "agente-off",
              "operator": {
                "type": "array",
                "operation": "notContains",
                "rightType": "any"
              }
            },
            {
              "id": "cf87bb7e-6bea-4697-bcd9-57e3b63998c2",
              "leftValue": "={{ $json.etiquetas }}",
              "rightValue": "testando-agente",
              "operator": {
                "type": "array",
                "operation": "contains",
                "rightType": "any"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -976,
        1760
      ],
      "id": "5204dcc5-b67d-4a82-b51f-17d9c47f3c10",
      "name": "Mensagem chegando?"
    }
  ],
  "pinData": {},
  "connections": {
    "Mensagem encavalada?1": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar mensagens1": {
      "main": [
        [
          {
            "node": "Mensagem encavalada?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens1": {
      "main": [
        [
          {
            "node": "Evolution API1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar1": {
      "main": [
        [
          {
            "node": "Buscar mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar arquivos1": {
      "ai_tool": [
        [
          {
            "node": "Secret√°ria1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Secret√°ria1": {
      "main": [
        [
          {
            "node": "Transform Output LLM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memory1": {
      "ai_memory": [
        [
          {
            "node": "Secret√°ria1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Refletir1": {
      "ai_tool": [
        [
          {
            "node": "Secret√°ria1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar mensagem.1": {
      "main": [
        [
          {
            "node": "Esperar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens1": {
      "main": [
        [
          {
            "node": "Secret√°ria1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info1": {
      "main": [
        []
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Info2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evolution API1": {
      "main": [
        [
          {
            "node": "Set mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Secret√°ria1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Apagar hist√≥rico1": {
      "main": [
        [
          {
            "node": "Msg memoria limpa1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Msg memoria limpa1": {
      "main": [
        [
          {
            "node": "Evolution API6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform Output LLM1": {
      "main": [
        [
          {
            "node": "Tipo de mensagem3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Return All Messages1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Return All Messages1": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items4": {
      "main": [
        [],
        [
          {
            "node": "Evolution API6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evolution API6": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download √°udio1": {
      "main": [
        [
          {
            "node": "OpenAI4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Download √°udio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI4": {
      "main": [
        [
          {
            "node": "Evolution API1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar nova mensagem1": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Enfileirar mensagem.1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Transcri√ß√£o de imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch6": {
      "main": [
        [
          {
            "node": "Apagar hist√≥rico1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "modo humano ativo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validar nova mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "modo humano ativo": {
      "main": [
        [
          {
            "node": "Edit Fields6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session Chatwoot1": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Pausar IA?1": {
      "main": [
        [],
        []
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Pausar IA?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "google_agenda": {
      "ai_tool": [
        [
          {
            "node": "Secret√°ria1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem recebida": {
      "main": [
        []
      ]
    },
    "MCP Google Calendar": {
      "ai_tool": [
        [
          {
            "node": "Secret√°ria",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Secret√°ria": {
      "main": [
        [
          {
            "node": "Tipo de mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar √°udio": {
      "main": [
        [
          {
            "node": "√Åudio para base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar SSML": {
      "main": [
        [
          {
            "node": "Gerar √°udio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem1": {
      "main": [
        [
          {
            "node": "Resetar status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatar SSML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memory": {
      "ai_memory": [
        [
          {
            "node": "Secret√°ria",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Refletir": {
      "ai_tool": [
        [
          {
            "node": "Secret√°ria",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Reagir mensagem": {
      "ai_tool": [
        [
          {
            "node": "Secret√°ria",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model.": {
      "ai_languageModel": [
        [
          {
            "node": "Formatar SSML",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Resetar status": {
      "main": [
        [
          {
            "node": "Tipo de mensagem2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem2": {
      "main": [
        [
          {
            "node": "Enviar texto.",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 para √°udio": {
      "main": [
        [
          {
            "node": "Enviar √°udio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "√Åudio para base64": {
      "main": [
        [
          {
            "node": "Resetar status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Base64 para √°udio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem teste": {
      "main": [
        []
      ]
    },
    "Info2": {
      "main": [
        [
          {
            "node": "Switch6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcri√ß√£o de imagem": {
      "main": [
        [
          {
            "node": "Secret√°ria1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar √°udio1": {
      "main": [
        [
          {
            "node": "√Åudio para base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar SSML1": {
      "main": [
        [
          {
            "node": "Gerar √°udio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem3": {
      "main": [
        [],
        [
          {
            "node": "Formatar SSML1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Formatar SSML1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Info": {
      "main": [
        [
          {
            "node": "Mensagem chegando?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens": {
      "main": [
        [
          {
            "node": "Secret√°ria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Digitando/Gravando...": {
      "main": [
        [
          {
            "node": "Set mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar como lidas": {
      "main": [
        [
          {
            "node": "Digitando/Gravando...",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar mensagem.": {
      "main": [
        [
          {
            "node": "Esperar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem": {
      "main": [
        [
          {
            "node": "Enfileirar mensagem.",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar": {
      "main": [
        [
          {
            "node": "Buscar mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens": {
      "main": [
        [
          {
            "node": "Marcar como lidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar mensagens": {
      "main": [
        [
          {
            "node": "Mensagem encavalada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem encavalada?": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem chegando?": {
      "main": [
        [
          {
            "node": "Tipo de mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4623fba5-7ce1-4640-868d-29463c3acc7b",
  "meta": {
    "instanceId": "d68d6b14db6671930aa9aed34a847c53eced9de105ebb8b4a3c96d1b2b42251c"
  },
  "id": "0PTMZQvzieRCswJo",
  "tags": []
}